#!/usr/bin/env bash

set -eu

app_name="${0##*/}"
app_version="0.0.0"

usage () {
  cat <<EOF
Print release README.md for the given version.

Usage:
  $ $app_name [options] <version>

Options:
  -h, --help     Print this message
  -v, --version  Print version number

Example:
  $ $app_name 0.1.0
EOF
}

main () {
  local version notes number minor prerelease url

  version="${1:-}"

  if ! [ "$version" ]; then
    echo "Version is required." >&2
    exit 1
  fi

  url="$(grep -m 1  '"bugs": "' package.json | cut -d'"' -f4 | cut -d'/' -f1-5)"

  # Remove development section, badges, replace branch URL references with the version tag.
  sed '/üõ†Ô∏è Development/,+5d' README.md \
    | sed '4 s/^\[!\[.*)$//' \
    | sed "s/\/main\//\/$version\//" \
    | sed "s/\/master\//\/$version\//" \
    | cat -s

  # Add changes section.
  notes="$(sed -e "1,/## $version/d" -e '/##/,$d' CHANGELOG.md)"

  if [ "$notes" ]; then
    cat <<EOF
üöÄ Changes in $version
-----
$notes

For changes in previous versions, see [CHANGELOG.md]($url/blob/$version/CHANGELOG.md).

EOF
  fi
}

case "${1:-}" in
  -h|--help) usage ;;
  -v|--version) echo "$app_version" ;;
  *) main "$@" ;;
esac
